# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# åŸºç¡€ç¯å¢ƒ
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
set -g default-terminal "tmux-256color"
set -as terminal-overrides ",*:RGB"
set -s escape-time 0
set -s extended-keys on
set -sg repeat-time 300
set -s focus-events on
set -g mouse on
set -g history-limit 10000
set -g detach-on-destroy off
set -g status-interval 5
set-hook -g client-session-changed 'refresh-client -S'

# Session åˆ›å»º/å…³é—­æ—¶è‡ªåŠ¨é‡ç¼–å·
set-hook -gu session-created
set-hook -g session-created 'run -b "~/.config/tmux/scripts/session_created.sh"'
set-hook -ag session-created 'run -b "tmux refresh-client -S"'
set-hook -gu session-closed
set-hook -g session-closed 'run -b "~/.config/tmux/scripts/session_created.sh"'
set-hook -ag session-closed 'run -b "tmux refresh-client -S"'

# èšç„¦ pane æ—¶è‡ªåŠ¨æ¸…é™¤ unread æ ‡è®° + acknowledge tracker ä»»åŠ¡
set-hook -gwu pane-focus-in
set-hook -gw pane-focus-in 'run -b "tmux set -wu -t #{window_id} @unread 2>/dev/null || true"'
set-hook -agw pane-focus-in 'run -b "test -x ~/.config/agent-tracker/bin/tracker-client && ~/.config/agent-tracker/bin/tracker-client command acknowledge --session-id #{session_id} --window-id #{window_id} --pane #{pane_id} || true"'
set-hook -agw pane-focus-in 'run -b "tmux refresh-client -S"'

# Pane å…³é—­æ—¶æ¸…ç† tracker ä»»åŠ¡
set-hook -gwu pane-died
set-hook -gw pane-died 'run -b "test -x ~/.config/agent-tracker/bin/tracker-client && ~/.config/agent-tracker/bin/tracker-client command delete_task --session-id #{session_id} --window-id #{window_id} --pane #{pane_id} || true"'

# å¯åŠ¨æ—¶ç¡®ä¿ç¼–å·è¿ç»­
run-shell "~/.config/tmux/scripts/session_created.sh"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ç¼–å·
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
set -g base-index 1
setw -g pane-base-index 1
setw -g automatic-rename on
set -g renumber-windows on

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Prefix
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
unbind C-b
set-option -g prefix C-a
bind-key C-a send-prefix

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# åŸºç¡€æ“ä½œ
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
bind b last-window
bind -n M-b last-window

bind r source-file ~/.config/tmux/tmux.conf \; display-message "tmux.conf reloaded"
bind . command-prompt -p "Rename session:" "run-shell \"~/.config/tmux/scripts/rename_session_prompt.sh '%%'\""
bind , command-prompt -p "Rename window:" "rename-window '%%'"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# åˆ†å±ï¼ˆå½“å‰ç›®å½•ï¼‰
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
bind \\ split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Pane å¯¼èˆªï¼ˆvim é£æ ¼ï¼‰
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
bind -r h select-pane -L
bind -r j select-pane -D
bind -r k select-pane -U
bind -r l select-pane -R

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Pane å¤§å°è°ƒæ•´
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
bind -r H resize-pane -L 3
bind -r J resize-pane -D 3
bind -r K resize-pane -U 3
bind -r L resize-pane -R 3

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Window åˆ‡æ¢ï¼ˆalt + numberï¼‰
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
bind -n M-1 select-window -t :1
bind -n M-2 select-window -t :2
bind -n M-3 select-window -t :3
bind -n M-4 select-window -t :4
bind -n M-5 select-window -t :5
bind -n M-6 select-window -t :6
bind -n M-7 select-window -t :7
bind -n M-8 select-window -t :8
bind -n M-9 select-window -t :9
bind -n M-0 select-window -t :10

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Session ç®¡ç†
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Ctrl+1~9 æŒ‰ç¼–å·åˆ‡æ¢ session
bind -n C-1 run-shell -b "~/.config/tmux/scripts/switch_session_by_index.sh 1"
bind -n C-2 run-shell -b "~/.config/tmux/scripts/switch_session_by_index.sh 2"
bind -n C-3 run-shell -b "~/.config/tmux/scripts/switch_session_by_index.sh 3"
bind -n C-4 run-shell -b "~/.config/tmux/scripts/switch_session_by_index.sh 4"
bind -n C-5 run-shell -b "~/.config/tmux/scripts/switch_session_by_index.sh 5"
bind -n C-6 run-shell -b "~/.config/tmux/scripts/switch_session_by_index.sh 6"
bind -n C-7 run-shell -b "~/.config/tmux/scripts/switch_session_by_index.sh 7"
bind -n C-8 run-shell -b "~/.config/tmux/scripts/switch_session_by_index.sh 8"
bind -n C-9 run-shell -b "~/.config/tmux/scripts/switch_session_by_index.sh 9"

# æ–°å»º sessionï¼ˆprefix + nï¼‰
bind n run-shell "~/.config/tmux/scripts/new_session.sh"
bind -n M-n run-shell "~/.config/tmux/scripts/new_session.sh"
bind -n M-q kill-window
bind -n M-Q kill-session

# ç§»åŠ¨ session é¡ºåºï¼ˆprefix + < / >ï¼‰
bind < run-shell "~/.config/tmux/scripts/move_session.sh left"
bind > run-shell "~/.config/tmux/scripts/move_session.sh right"

# ç§»åŠ¨å½“å‰ window åˆ° session Nï¼ˆprefix + 1~9ï¼‰
unbind 1; unbind 2; unbind 3; unbind 4; unbind 5
unbind 6; unbind 7; unbind 8; unbind 9; unbind 0
bind 1 run-shell "~/.config/tmux/scripts/move_window_to_session.sh 1"
bind 2 run-shell "~/.config/tmux/scripts/move_window_to_session.sh 2"
bind 3 run-shell "~/.config/tmux/scripts/move_window_to_session.sh 3"
bind 4 run-shell "~/.config/tmux/scripts/move_window_to_session.sh 4"
bind 5 run-shell "~/.config/tmux/scripts/move_window_to_session.sh 5"
bind 6 run-shell "~/.config/tmux/scripts/move_window_to_session.sh 6"
bind 7 run-shell "~/.config/tmux/scripts/move_window_to_session.sh 7"
bind 8 run-shell "~/.config/tmux/scripts/move_window_to_session.sh 8"
bind 9 run-shell "~/.config/tmux/scripts/move_window_to_session.sh 9"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Watch Paneï¼ˆé•¿å‘½ä»¤å®Œæˆé€šçŸ¥ï¼‰
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# prefix + w: ç›‘æ§å½“å‰ paneï¼Œå‘½ä»¤å®Œæˆåæ ‡ ğŸ””
bind w run-shell -b '~/.config/tmux/scripts/watch_pane.sh "#{pane_id}" "#{window_id}"'

# prefix + W: æ‰‹åŠ¨åˆ‡æ¢ unread æ ‡è®°
bind W run-shell 'val=$(tmux show -wv @unread 2>/dev/null); if [ "$val" = "1" ]; then tmux set -wu @unread; else tmux set -w @unread 1; fi; tmux refresh-client -S'

# M-m: è·³è½¬åˆ°æœ‰é€šçŸ¥çš„ windowï¼ˆæ— éœ€ prefixï¼‰
bind -n M-m run-shell -b '~/.config/tmux/scripts/focus_notified.sh'
# M-M: è·³å›ä¹‹å‰çš„ä½ç½®
bind -n M-M run-shell -b '~/.config/tmux/scripts/focus_back.sh'

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# å¯¼å‡º Pane åˆ° HTML
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# prefix + E: å¯¼å‡ºå½“å‰ pane å®Œæ•´å†…å®¹åˆ° HTMLï¼Œè·¯å¾„å¤åˆ¶åˆ°å‰ªè´´æ¿
bind E run-shell -b '~/.config/tmux/scripts/export_pane_html.sh "#{pane_id}"'

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Copy Modeï¼ˆvi é£æ ¼ï¼‰
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
setw -g mode-keys vi
bind -T copy-mode-vi v send-keys -X begin-selection
bind -T copy-mode-vi y send-keys -X copy-selection-and-cancel
bind -T copy-mode MouseDown1Pane send-keys -X cancel

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# å¤–è§‚
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# è°ƒè‰²æ¿ï¼ˆKanagawa é£æ ¼ï¼‰
# bg:      #1F1F28
# sumiInk: #2A2A37
# fujiGray:#727169
# oldWhite:#C8C093
# sakura:  #D27E99
# wave:    #7E9CD8

set -g status-position bottom
set -g status-style "bg=#1F1F28"

# â”€â”€ å·¦ä¾§ï¼šsession æ ‡ç­¾é¡µï¼ˆpowerline é£æ ¼ï¼‰â”€â”€
set -g status-left-length 90
set -g status-left "#(~/.config/tmux/tmux-status/left.sh '#{session_id}' '#{session_name}')   "

# â”€â”€ å³ä¾§ï¼šæ—¥æœŸæ—¶é—´ï¼ˆpowerline é£æ ¼ï¼‰â”€â”€
set -g status-right-length 50
set -g status-right "#[fg=#2A2A37,bg=#1F1F28]î‚²#[fg=#C8C093,bg=#2A2A37]  %m/%d #[fg=#7E9CD8,bg=#2A2A37]î‚²#[fg=#1F1F28,bg=#7E9CD8,bold]  %H:%M "

# â”€â”€ Window åˆ—è¡¨ â”€â”€
setw -g window-status-format "#[fg=#727169]  #W#{?#{@unread},ğŸ””,#{?#{@watching},â³,}} "
setw -g window-status-current-format "#[fg=#D27E99,bold]  #W#{?#{@unread},ğŸ””,#{?#{@watching},â³,}} "
setw -g window-status-separator ""

# â”€â”€ Pane è¾¹æ¡† â”€â”€
set -g pane-border-style "fg=#2A2A37"
set -g pane-active-border-style "fg=#7E9CD8"
set -g pane-border-lines heavy

# â”€â”€ æ¶ˆæ¯ & å‘½ä»¤è¡Œ â”€â”€
set -g message-style "fg=#C8C093,bg=#2A2A37"
set -g message-command-style "fg=#D27E99,bg=#2A2A37"

# â”€â”€ é€‰æ‹©æ¨¡å¼ â”€â”€
set -g mode-style "fg=#1F1F28,bg=#D27E99"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# æ’ä»¶
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @resurrect-capture-pane-contents 'on'
set -g @continuum-save-interval '0'
# set -g @continuum-restore 'on'
set -g @plugin 'omerxx/tmux-sessionx'
set -g @sessionx-bind 'o'
set -g @sessionx-window-mode 'on'
set -g @sessionx-filter-current 'false'

# TPM åˆå§‹åŒ–ï¼ˆå¿…é¡»æ”¾æœ€åä¸€è¡Œï¼‰
run '~/.tmux/plugins/tpm/tpm'
